% ==============================================================================
% WritingLab Beamer Theme - Quantum Spectrum Edition
% ==============================================================================
% 版本: V4.0 (2025/11/23)
% 描述: 专为量子信息与物理学科设计的扁平化、高对比度、护眼 Beamer 主题。
%       集成全息渐变标题、流体胶囊页脚与语义化数学环境。
% 
% ------------------------------------------------------------------------------
% [A] 核心配色索引 (Color ID System)
% ------------------------------------------------------------------------------
% 本模板的大多数盒子环境支持可选参数 [1-6]，对应以下语义色：
%   [1] WLTeal   (青色) : 主色调     | 代表：量子比特、核心概念
%   [2] WLGreen  (绿色) : 算法/代码  | 代表：执行步骤、正确、通过
%   [3] TitleBlue(蓝色) : 定理/结论  | 代表：数学推导、理论基础
%   [4] TitleBdg (紫色) : 引理/辅助  | 代表：叠加态、中间过程
%   [5] WLOrange (橙色) : 强调/警告  | 代表：能量、注意点、Todo
%   [6] WLGray   (灰色) : 备注/引用  | 代表：背景信息、补充说明
%
% ------------------------------------------------------------------------------
% [B] 常用环境与命令速查 (Usage Cheatsheet)
% ------------------------------------------------------------------------------
% 1. 数学环境 (自动编号与配色)
%    \begin{theorem}[标题] ... \end{theorem}    -> 蓝色系
%    \begin{lemma}[标题] ... \end{lemma}        -> 紫色系
%    \begin{proof} ... \end{proof}              -> 灰色斜体 + QED
%    \begin{algorithm}[名称] ... \end{algorithm}-> 绿色系
%
% 2. 重点公式盒子 (参数 [n] 为颜色 ID，默认为 [1])
%    \begin{eqbox}[n] ... \end{eqbox}    -> 浅色背景 (最常用，推荐)
%    \begin{feqbox}[n] ... \end{feqbox}  -> 深色填充 + 白字 (极强强调)
%    \begin{ceqbox}[n] ... \end{ceqbox}  -> 仅描边框 (轻量级)
%    \begin{bfeqbox}[n]... \end{bfeqbox} -> 深色填充 + 粗体数学字
%
% 3. 布局盒子
%    \begin{outlinebox}[颜色名] ... \end{outlinebox} -> 简单细线框
%    \begin{fillbox}[背景色名] ... \end{fillbox}    -> 简单色块
%    \begin{stylebox}[ID]{标题} ... \end{stylebox}   -> 带标题的标准框
%    \begin{sidebox}[ID]{标题} 左侧 \tcblower 右侧 \end{sidebox} -> 左右分栏
%
% 4. 特殊页面
%    \maketitle          -> 生成全息渐变标题页
%    \ThankYouPage[文字] -> 生成全息渐变结束页 (默认: Thanks for...)
%
% ==============================================================================

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{beamerthemeWritingLab}[2025/11/23 v4.0 Quantum Spectrum]

\mode<presentation>

% =============================================
% 1. 基础宏包加载
% =============================================
\RequirePackage{xcolor}
\RequirePackage{tikz}
% \RequirePackage{transparent} % 已弃用，改用 tikz 的 opacity 功能
\RequirePackage{varwidth} 
\RequirePackage[most]{tcolorbox} 
\RequirePackage{etoolbox}

\usetikzlibrary{fadings, patterns, calc} 

% 渐变计数器
\newcounter{gradientcounter}

% =============================================
% 2. 颜色定义 (量子光谱配色方案)
% =============================================

% --- 核心主题色 (深色，用于文字和线条) ---
% Quantum Teal: 主色，代表量子比特、科技、冷静
\definecolor{WLTeal}{HTML}{00897B}      
% Superposition Violet: 辅色，代表数学、叠加态、优雅
\definecolor{WLViolet}{HTML}{5E35B1}    
% Photon Orange: 强调色，代表能量、光子、警告
\definecolor{WLOrange}{HTML}{FF7043}    
% Science Blue: 结构色，代表学术、稳重 (用于标题栏)
\definecolor{WLBlue}{HTML}{1565C0}      
% Logic Gray: 中性色，代表逻辑、辅助信息
\definecolor{WLGray}{HTML}{546E7A}  
% Logic Green: 算法色，代表执行、步骤、代码
\definecolor{WLGreen}{HTML}{2E7D32}    

% --- 护眼背景色 (极淡色，用于色块背景) ---
% 采用低饱和度设计，接近纸张质感，减少屏幕刺眼感
\definecolor{BG_Teal}{HTML}{E0F2F1}     % 极淡青
\definecolor{BG_Violet}{HTML}{EDE7F6}   % 极淡紫
\definecolor{BG_Orange}{HTML}{FBE9E7}   % 极淡橙
\definecolor{BG_Blue}{HTML}{E3F2FD}     % 极淡蓝
\definecolor{BG_Gray}{HTML}{F5F7F8}     % 极淡灰 (冷调)

% Put this BEFORE your stylebox definition
\newcommand{\ListBg}{WLBlue}  % 全局默认值
\newcommand{\ListFg}{white}

% =============================================
% 3. Tcolorbox 容器定义
% =============================================

\def\globalradius{10pt} 

% --- 类型 A: 细线框 (通用高亮) ---
\newtcolorbox{outlinebox}[1][WLTeal]{
    enhanced,
    colback=white,
    colframe=#1,          % 边框颜色
    boxrule=1pt,
    arc=\globalradius,
    boxsep=0pt,
    left=6pt, right=6pt, top=5pt, bottom=5pt
}

% --- 类型 B: 填充框 (强调区域) ---
\newtcolorbox{fillbox}[1][BG_Teal]{
    enhanced,
    colback=#1,
    colframe=#1,
    boxrule=0pt,
    arc=\globalradius,
    boxsep=0pt,
    left=8pt, right=8pt, top=6pt, bottom=6pt,
    fonttitle=\bfseries,
    title after break={}
}

% =============================================
% 4. Beamer 全局配色映射
% =============================================
\setbeamercolor{normal text}{fg=black!90, bg=white} % 正文不使用纯黑，减轻对比疲劳
\setbeamercolor{structure}{fg=WLBlue}               % 结构元素使用稳重的蓝色
\setbeamercolor{frametitle}{fg=WLBlue, bg=white}
\setbeamercolor{title}{fg=black, bg=white}

% Block 样式 (原生 Block)
\setbeamercolor{block title}{fg=white, bg=WLBlue}
\setbeamercolor{block body}{fg=black!90, bg=BG_Blue} 

% Alert 样式 (警告/高亮)
\setbeamercolor{block title alerted}{fg=white, bg=WLOrange}
\setbeamercolor{block body alerted}{fg=black!90, bg=BG_Orange}
\setbeamercolor{alerted text}{fg=WLOrange}

% =============================================
% 5. 布局与字体设置
% =============================================
\useinnertheme[shadow=false]{rounded} 
\setbeamertemplate{itemize items}[circle]
\setbeamertemplate{navigation symbols}{}
\usefonttheme{professionalfonts} 
\setbeamerfont{frametitle}{size=\Large, series=\bfseries}
% =============================================
% [新增] 自定义标题栏布局 (Frametitle Layout)
% 修复默认标题栏占用过多垂直空间的问题
% =============================================
\setbeamertemplate{frametitle}{
    \nointerlineskip % 防止插入额外的行间距
    
    % --- 标题盒子 ---
    % wd=\paperwidth : 宽度占满全屏
    % ht=2.5ex       : 标题文字的高度预留 (根据字号调整)
    % dp=1.0ex       : 标题文字的深度预留 (防止字母 g, j, p, q, y 被切断)
    % leftskip=0.5em : 左侧缩进量
    \begin{beamercolorbox}[wd=\paperwidth, ht=2.5ex, dp=1.0ex, leftskip=0.5em]{frametitle}
        \usebeamerfont{frametitle}\insertframetitle
    \end{beamercolorbox}
    
    % --- 垂直间距修正 (关键) ---
    % 修改下方的数值来拉近正文与标题的距离
    % 正数增加间距，负数减小间距
    \vspace{-1.5em} 
}

% --- 页脚: 智能流体胶囊 (Smart Liquid Capsule) ---
% 包含: 全息渐变 + 智能文字反色技术
% =============================================
% 优化后的页脚: 方案三 (深轨胶囊 - Deep Track Style)
% 特点：
% 1. 文字始终为纯白色 (White)，无阴阳变化，清晰锐利。
% 2. 轨道背景加深为 WLGray (逻辑灰)，完美衬托白色文字。
% 3. 进度条保留流体渐变，色彩鲜艳。
% =============================================

\setbeamertemplate{footline}{%
  \leavevmode%
  \begin{tikzpicture}[remember picture, overlay]
      % 1. 参数定义 (保持小巧精致)
      \def\barwidth{42pt}      % 宽度小巧
      \def\barheight{10pt}     % 高度精致
      \def\xoffset{15pt}       
      \def\yoffset{8pt}        
      \def\cradius{5pt}        % 圆角
      
      % 2. 坐标计算
      \coordinate (br) at ($(current page.south east) + (-\xoffset, \yoffset)$);
      \coordinate (bl) at ($(br) - (\barwidth, 0)$);
      \coordinate (tr) at ($(br) + (0, \barheight)$);
      \coordinate (center) at ($(bl)!0.5!(tr)$);
      
      % 3. 进度计算
      \pgfmathtruncatemacro{\total}{\inserttotalframenumber}
      \pgfmathtruncatemacro{\current}{\insertframenumber}
      \ifnum\total>1
          \pgfmathsetmacro{\progress}{(\current - 1) / (\total - 1)}
          \pgfmathsetmacro{\fillw}{\barheight + \progress * (\barwidth - \barheight)}
      \else
          \pgfmathsetmacro{\fillw}{\barwidth}
      \fi
      
      % --- 绘制图层 ---

      % Layer A: 深色轨道槽 (Track) - 关键修改
      % 使用 WLGray (逻辑灰) 作为底色。
      % 这样无论进度走到哪里，白色文字底部都有深色衬托。
      \fill[WLGray!60, rounded corners=\cradius] (bl) rectangle (tr);

      % Layer B: 渐变进度条 (Gradient Fill)
      % 只需要裁剪并绘制渐变，不需要再处理文字
      \begin{scope}
          \clip[rounded corners=\cradius] (bl) rectangle ($(bl) + (\fillw pt, \barheight)$);
          \shade[left color=TitleBlue, right color=TitleOrange, middle color=TitleBridge, shading angle=-30] 
                (bl) rectangle (tr);
      \end{scope}
      
      % Layer C: 统一白色文字 (Uniform White Text)
      % 渲染在最顶层，始终清晰可见
      \node at (center) [font=\tiny\bfseries\sffamily, text=white] 
            {\insertframenumber{} / \inserttotalframenumber};

  \end{tikzpicture}
}

% =============================================
% 6. 渐变标题逻辑 (Quantum Glass - 现代轻量化高反差版)
% =============================================

% --- 颜色定义：参照 iOS 系统级色彩，轻盈且清晰 ---

% 1. Azure Clear: 蔚蓝澄空
%    [位置：左侧/冷端]
%    这是一个标准的“科技蓝”，比之前的深蓝 (#0052CC) 提亮了 30%。
%    它既保留了量子信息的专业感，又去掉了“重工业”的沉闷感。
%    在白底上阅读非常舒适，像冬天的天空一样干净。
\definecolor{TitleBlue}{HTML}{007AFF} 

% 2. Persimmon Glow: 暖柿微光
%    [位置：右侧/暖端]
%    我们放弃了厚重的红橙色，选用了这种高明度的鲜橙色。
%    它非常显眼，带来了强烈的温度感，但完全不压抑。
%    (注：为了保证文字清晰，比纯黄橙稍微加深了一点点)
\definecolor{TitleOrange}{HTML}{FF6D00} 

% 3. Amethyst Mist: 紫晶薄雾
%    [位置：中间/桥梁]
%    这是“去重”的关键。
%    之前的深紫/深红太抢眼了，导致中间视觉压力大。
%    现在的这个紫色，带有一点粉调，明度较高。
%    它起到了完美的柔顺剂作用，让“冰”化为“水”，再变成“汽”。
\definecolor{TitleBridge}{HTML}{AF52DE} 

\newcommand{\GradientTitle}[1]{%
    \stepcounter{gradientcounter}%
    \begin{tikzfadingfrompicture}[name=fading\thegradientcounter]
        \node [text=white, inner sep=10pt, outer sep=0pt] 
              {\begin{varwidth}{\linewidth}\centering#1\end{varwidth}};
    \end{tikzfadingfrompicture}%
    \begin{tikzpicture}
        \node [text=white, inner sep=10pt, outer sep=0pt, opacity=0] (textnode) 
              {\begin{varwidth}{\linewidth}\centering#1\end{varwidth}};
        
        % --- 渐变逻辑 ---
        % 路线：蔚蓝 -> 紫晶 -> 暖橙
        % 角度：-30度 (优雅倾斜)
        % 
        % 视觉体验：
        % 这种配色就像透过一块高科技玻璃看世界。
        % 没有黑色的沉重，没有灰色的浑浊。
        % 只有纯粹的光色流转，既保持了冬日的冷暖反差，
        % 又让人觉得轻盈、透气、现代。
        \shade[path fading=fading\thegradientcounter, fit fading=false, 
               left color=TitleBlue, 
               right color=TitleOrange,
               middle color=TitleBridge, 
               shading angle=-30] 
               (textnode.south west) rectangle (textnode.north east);
    \end{tikzpicture}%
}

\setbeamertemplate{title page}{
    \vbox{}\vfill
    \begingroup\centering
        
        % 1. 标题：从 \Huge 改为 \huge，防止三行折行过于拥挤
        \GradientTitle{\huge\bfseries\inserttitle}\par
        
        % 2. 副标题：增加一点顶部间距
        \ifx\insertsubtitle\@empty\else
            \vspace{0.8em}
            {\usebeamerfont{subtitle}\color{WLGray}\large\insertsubtitle\par}
        \fi
        
        % 3. 装饰分割线 (视觉重心分割)
        \vspace{0.8em}
        
        % 4. 作者：去掉了 \bfseries (粗体)，改为 \large，让名字更清爽
        {\usebeamerfont{author}\large\insertauthor}\par
        
        % 5. 机构：稍微拉开一点间距
        \vspace{0.6em}
        {\usebeamerfont{institute}\small\color{WLGray}\insertinstitute}\par
        
        % 6. 日期/汇报人：放在最底部
        \vspace{1.2cm}
        {\usebeamerfont{date}\small\color{WLGray}\insertdate}\par
        
    \endgroup\vfill
}

\newcommand{\ThankYouPage}[1][Thanks for your\\attention.]{
    \begin{frame}[plain,noframenumbering]
        \centering\vfill
        \GradientTitle{\textit{\bfseries\fontsize{40pt}{45pt}\selectfont #1}}
        \vfill
    \end{frame}
}

% =============================================
% 7. 目录 (TOC) 美化设置 - 方案二：极简玻璃卡片
% =============================================

% --- 章节 (Section) 样式 ---
\setbeamertemplate{section in toc}{%
  \vspace{0.3em}
  \begin{tcolorbox}[
      enhanced,
      colback=BG_Blue!60!white, % 极淡蓝背景
      colframe=white,           % 无边框
      boxrule=0pt,
      left=0pt, right=0pt, top=6pt, bottom=6pt,
      interior style={
          left color=BG_Blue!40!white,
          right color=white
      },
      % 左侧装饰条 (量子青)
      overlay={
          \fill[WLTeal, rounded corners=2pt] (frame.north west) ++(0pt,-2pt) rectangle ++(4pt,-\baselineskip-8pt);
      }
  ]
      \hspace{1.2em}%
      % 数字
      \textcolor{WLTeal}{\bfseries\Large \inserttocsectionnumber}\quad
      % 标题
      \textcolor{WLBlue}{\bfseries\large \inserttocsection}
  \end{tcolorbox}
}

% --- 子章节 (Subsection) 样式 ---
\setbeamertemplate{subsection in toc}{%
  \leavevmode\leftskip=3.5em%
  \begin{tikzpicture}[baseline=(current bounding box.center)]
      \fill[WLGray!50] (0,0.1) circle (1.5pt);
  \end{tikzpicture}\ 
  {\color{WLGray}\inserttocsubsection}\par
  \vspace{0.3em}
}

% =============================================
% 8. 数学环境定义 (Refactored & Optimized)
% =============================================

% --- 0. 清除旧定义 ---
\let\theorem\relax    \let\endtheorem\relax
\let\lemma\relax      \let\endlemma\relax
\let\proof\relax      \let\endproof\relax
\let\corollary\relax  \let\endcorollary\relax

% --- 核心：提取公共样式 (DRY Principle) ---
\tcbset{
    % [布局基类] 统一所有盒子的几何形状
    wl/layout/.style={
        enhanced,
        boxrule=0pt,
        arc=10pt,
        left=10pt, right=10pt, top=8pt, bottom=8pt,
    },
    % [数学修正] 消除公式垂直间距的黑魔法
    wl/resetmath/.style={
        before upper={%
            \setlength{\abovedisplayskip}{0pt}%
            \setlength{\belowdisplayskip}{0pt}%
            \setlength{\abovedisplayshortskip}{0pt}%
            \setlength{\belowdisplayshortskip}{0pt}%
        }
    },
    % [标准盒子] 用于定理、引理等带标题的盒子
    wl/compactbox/.style args={#1}{% #1 = Color Name
        wl/layout,
        bottom=5pt, % 微调底部
        colback=#1!10!white,
        coltitle=#1,
        fonttitle=\bfseries\large,
        attach title to upper={\quad},
        after skip=1.5em,
    }
}

% --- 1. 标准数学环境 (使用 compactbox 样式) ---

% Theorem: 量子深蓝
\newtcolorbox{theorem}[1][]{
    wl/compactbox={TitleBlue},
    title={Theorem\ifstrempty{#1}{}{ (#1).}}
}

% Lemma: 量子青
\newtcolorbox{lemma}[1][]{
    wl/compactbox={TitleBridge},
    coltitle=TitleBridge!80!black, % 特殊微调
    title={Lemma\ifstrempty{#1}{}{ (#1).}}
}

% Corollary
\newtcolorbox{corollary}[1][]{
    wl/compactbox={TitleBridge},
    coltitle=TitleBridge!80!black,
    title={Corollary\ifstrempty{#1}{}{ (#1).}}
}

% Proof: 紧凑灰 (特殊处理：斜体 + QED)
\newtcolorbox{proof}[1][Proof]{
    wl/layout,
    bottom=5pt,
    colback=black!3,
    coltitle=black!60,
    title={#1.},
    fonttitle=\bfseries\large,
    attach title to upper={\quad},
    after skip=1.5em,
    fontupper=\itshape,
    after upper={\par\vspace{-0.7em}\hfill\textcolor{black!60}{\ensuremath{\blacksquare}}}
}

% Algorithm: 逻辑绿
\newtcolorbox{algorithm}[1][]{
    wl/compactbox={WLGreen},
    title={Algorithm\ifstrempty{#1}{}{ (#1).}}
}

% 辅助逻辑：数字 -> 颜色 映射表
\ExplSyntaxOn
\NewExpandableDocumentCommand{\wlnumtocolor}{m}
 {
  \str_case:nnF { #1 }
   {
    {1}{WLTeal}       % 1: 主色
    {2}{WLGreen}      % 2: 算法/正确
    {3}{TitleBlue}    % 3: 定理/核心
    {4}{TitleBridge}  % 4: 引理/辅助
    {5}{WLOrange}     % 5: 强调/警告
    {6}{WLGray}       % 6: 备注
   }
   { #1 }
 }
\ExplSyntaxOff

% =============================================
% 9. 自定义功能盒子 (Optimized)
% =============================================

% --- Style Box: 万能自定义框 ---
\newtcolorbox{stylebox}[2][1]{
    wl/compactbox={\wlnumtocolor{#1}}, % 复用上面的样式
    title={\ifstrempty{#2}{}{#2.}},
    % 修复列表颜色问题的关键钩子
    fontupper={
        \renewcommand{\ListBg}{\wlnumtocolor{#1}}
    }
}

% --- Side-by-Side Box ---
\newtcolorbox{sidebox}[2][1]{
    wl/layout,
    colback=\wlnumtocolor{#1}!10!white,
    sidebyside,
    sidebyside align=center,
    sidebyside gap=0pt,
    lefthand width=3cm,
    segmentation hidden,
    before upper={%
        \textcolor{\wlnumtocolor{#1}}{\textbf{\large #2}}%
        \tcblower%
        \renewcommand{\ListBg}{\wlnumtocolor{#1}}% 修复右侧列表颜色
        \colorlet{CurrentBoxColor}{\wlnumtocolor{#1}}%
    }
}

% =============================================
% 10. 公式盒子系列 (Fixed for Compatibility)
% =============================================

% --- 1. 定义配色模式 (只负责背景和边框，不处理字体) ---
\tcbset{
    % 模式A: 填充 (Filled)
    wl/mode/filled/.style={
        colback=\tempcolor,
        colframe=\tempcolor,
        boxrule=0pt,
    },
    % 模式B: 描边 (Outline)
    wl/mode/outline/.style={
        colback=white,
        colframe=\tempcolor!60!white,
        boxrule=1.5pt,
    },
    % 模式C: 浅色背景 (Pale)
    wl/mode/pale/.style={
        colback=\tempcolor!10!white,
        boxrule=0pt,
    }
}

% --- 2. 定义字体逻辑 (显式处理字体组合) ---
% 参数 #1 是用户传入的额外字体命令 (例如 \bfseries)
\tcbset{
    % Filled 模式: 强制白色 + 用户字体
    wl/font/filled/.style={ fontupper=\color{white}#1 },
    % Outline 模式: 强制主题色 + 用户字体
    wl/font/outline/.style={ fontupper=\color{\tempcolor}#1 },
    % Pale 模式: 仅用户字体
    wl/font/pale/.style={ fontupper=#1 }
}

% --- 3. 统一构建器 (Builder) ---
% 参数 #1: 颜色ID (1-6)
% 参数 #2: 模式名称 (filled/outline/pale)
% 参数 #3: 额外字体命令 (例如 \bfseries \boldmath)
\tcbset{
    wl/eqbuilder/.code n args={3}{%
        % 1. 计算当前颜色
        \edef\tempcolor{\wlnumtocolor{#1}}%
        % 2. 应用样式
        \tcbset{
            wl/layout,          % 加载通用布局
            wl/resetmath,       % 加载数学间距修正
            wl/mode/#2,         % 加载背景/边框样式
            wl/font/#2={#3},    % 加载字体样式 (核心修复点)
            top=5pt, bottom=5pt,% 公式专用微调
            check odd page=true
        }%
    }
}

% --- 4. 盒子定义 ---

% EqBox: 浅色背景 (标准版)
\newtcolorbox{eqbox}[1][1]{
    wl/eqbuilder={#1}{pale}{}
}

% CeqBox: 描边风格
\newtcolorbox{ceqbox}[1][1]{
    wl/eqbuilder={#1}{outline}{}
}
% TeqBox: 描边风格 (修改版：支持标题，标题变色，内容黑字)
\newtcolorbox{tceqbox}[2][1]{
    wl/eqbuilder={#1}{outline}{}, % 1. 继承原有描边与颜色计算(\tempcolor)
    title={#2},                   % 2. 启用标题参数
    coltitle=\tempcolor,          % 3. 标题颜色 = 计算出的主题色
    fonttitle=\bfseries,          % 4. 标题加粗
    attach title to upper={\par}, % 5. 样式调整：标题在框内首行显示
    fontupper=\color{black!90}    % 6. 关键：强制将正文重置为深灰色（覆盖默认的变色）
}
\newtcolorbox{oceqbox}[2][1]{
    wl/eqbuilder={#1}{outline}{},
    title={#2},
    coltitle=\tempcolor,
    fonttitle=\bfseries,
    attach title to upper={\quad}, % <--- 修改这里：用 \quad 代替 \par
    fontupper=\color{black!90}
}

% FCeqBox: 描边 + 彩色字体 (保留兼容性)
\newtcolorbox{fceqbox}[1][1]{
    wl/eqbuilder={#1}{outline}{}
}

% FEqBox: 填充风格
\newtcolorbox{feqbox}[1][1]{
    wl/eqbuilder={#1}{filled}{}
}

% BFEqBox: 填充 + 加粗风格
\newtcolorbox{bfeqbox}[1][1]{
    wl/eqbuilder={#1}{filled}{\bfseries\boldmath}
}
% =============================================
% 9. 全局列表样式 (封装版)
% =============================================

% --- 1. 有序列表 (模板保持干净，只引用变量) ---
\setbeamertemplate{enumerate item}{%
  \raisebox{-3pt}{%
    \begin{tikzpicture}
      \node[
        fill=\ListBg,          % <--- 只引用变量，不包含逻辑
        circle,                 
        text=\ListFg,          
        inner sep=0pt,          
        minimum size=1.2em,     
        font=\scriptsize\bfseries 
      ] {\insertenumlabel};
    \end{tikzpicture}%
  }%
}

% --- 2. 二级列表 ---
\setbeamertemplate{enumerate subitem}{%
  \raisebox{-1pt}{%
    \begin{tikzpicture}
      \node[
        fill=\ListBg!70!white, % <--- 变量变淡
        rounded corners=3pt,        
        rectangle, 
        text=\ListFg,          
        inner sep=1.5pt, 
        minimum size=1.1em,
        font=\tiny\bfseries
      ] {\insertenumlabel};
    \end{tikzpicture}%
  }%
}

% --- 3. 无序列表 ---
\setbeamertemplate{itemize item}{%
  \raisebox{1pt}{\tikz\fill[\ListBg] (0,0) circle (0.22em);}%
}

\setbeamertemplate{itemize subitem}{%
  \raisebox{1pt}{\tikz\fill[\ListBg!70!white] (0,0) circle (0.18em);}%
}
\newcommand{\smartball}[2][\ListBg]{%  <-- 重点：默认值设为 \ListBg
    \begin{tikzpicture}[baseline=-3pt]
        \node[
            fill=#1,                % 使用传入的颜色变量
            circle, 
            text=white, 
            inner sep=0pt, 
            minimum size=1.3em, 
            text width=1.3em,
            align=center, 
            font=\scriptsize\bfseries
        ] {#2};
    \end{tikzpicture}%
}
\mode<all>